# Java环境下的微服务

## 本文涉及的内容，能让你学到什么？

本书适用于开发微服务的Java开发人员和架构师。我们在开始介绍微服务架构前，先讲述一些抽象的基本概念。不幸的是，使用新技术并不能神奇地解决分布式系统问题。但是我们通过一些做的很好的公司，它们是如何使用微服务来进行构建的，包括文化、组织结构和市场压力。然后我们深入了解几个Java微服务框架，附带的源代码反馈可以在GitHub上找到。我们会讨论有关部署、集群、故障转移以及Docker和Kubernetes在这些领域是如何解决这些问题。随后我们会重点介绍一些使用Docker，Kubernetes和NetflixOSS的示例，以演示微服务架构。我们这么少的章节无法讨论所有的问题，但不代表除了这些其他的都不重要，比如：配置、日志记录和连续交付。

微服务不仅仅是技术上的讨论。 微服务的实现源于复杂自适应理论，服务设计，技术演进，领域驱动设计，依赖考量等背景。 它们允许使用这些技术的组织，能够真正地展示敏捷、快速响应并在快速发展的商业世界中保持竞争力。 让我们近距离的来看看吧。

## 你实际是在为一家软件公司工作

软件正在统治这个世界。企业正在慢慢意识到这一点，这个现象有两个主要的驱动因素：通过高品质的服务和技术的快速投产来提供价值。 这本书主要是涉及到动手实践，但在我们深入了解技术之前，我们需要适当地了解整个环境以及关键因素。近年来我们一直在谈论让企业如何变得敏捷，但我们需要充分了解这是什么意思，否则一切都是都是白搭。

### 服务的价值

100多年来，我们的商业市场一直在创造产品，并推动消费者想要这些产品：书桌，微波炉，汽车，鞋子等等。 “生产者主导”经济背后的理念来自于亨利·福特（Henry Ford）的观点：“如果您能以低成本生产大量产品，市场几乎是无限的”。为了达到目的，还需要几个单向渠道直接向客户进行营销，以说服他们他们需要这些产品，并且他们的生活将会由这些产品得以大大的改善。在20世纪的大部分时间里，这些单向渠道以电视、报纸、杂志广告和高速公路广告牌等形式存在。然而，这个生产者主导的经济已经翻篇了，因为市场中充满了过剩的产品（你需要多少手机/汽车/电视机？）此外，互联网以及社交网络正在改变公司如何与消费者（或更重要的是消费者如何与他们互动）的交互渠道。

社交网络使作为消费者的我们能够更自由地彼此分享我们对于公司产品的看法和意见。与营销渠道相比，我们更加相信自己的家人和朋友。这就是为什么我们去社交媒体选择餐馆、酒店和航空公司。我们以点评、评价以及朋友圈等等形式进行反馈，好的反馈能够对公司的品牌产生积极的推动作用，反之，能让某些公司伤透脑筋。现在，公司和消费者之间的双向关系前所未有，公司需要更加努力的经营自己的品牌。

<center>
<img src="https://github.com/weipeng2k/microservices-camp/raw/master/resource/chapter1-1.png" width="50%" height="50%" />
</center>

后工业公司正在学习如何培养和客户之间的关系（使用双向渠道沟通），并通过这些关系让客户了解到自己的产品如何为他们带来价值。公司通过服务、客户体验和反馈来提供持续维系这些关系。客户根据对于自身的价值和体验来选择哪些服务消费。以Uber为例，它本身并不拥有任何库存和售卖的商品，坐在别人的车里，对于我并没有任何价值，但通常会由我想要去某个地方（例如商业会议）而带来价值。通过这种方式，Uber和我通过对服务的使用来创造价值。展望未来，公司将需要专注于为客户提供有价值的服务，而服务的形式也包括了信息技术服务。

### 技术的商品化

技术与经济、生物和法律相似，有繁荣与萧条循环周期，技术引起了伟大的创新，如：蒸汽机、电话和计算机。在竞争激烈的市场中，不断变化的创新需要大量的投资和建设才能快速适应各自的市场。而这将带来更多的竞争、更强的能力和更低的价格，最终使创新技术成为商品。持续创新和改进将成为不断的循环。 这种商品化使我们经历了大型机、个人计算机，直到现在所谓的“云计算”，而它的出现使我们的商业计算几乎没有前期的资本投入。在云计算的基础上，我们正在为技术服务带来新的创新。

<center>
<img src="https://github.com/weipeng2k/microservices-camp/raw/master/resource/chapter1-2.png" width="50%" height="50%" />
</center>

开源技术也是技术领域的引领者。随着时间的推移，开发人员可以使用开源技术用很低的成本构建一个原来需要昂贵专有软件才能构建的产品。这驱使社区构建了诸如：操作系统（Linux）、编程语言（Go）、消息队列（Apache ActiveMQ）和Web服务器（httpd）等知名的产品。即使是最初拒绝开源的公司也开源他们自己的技术并为现有社区做出贡献。随着开源和开放的生态系统已经成为常态，我们开始直接从开放源码社区（例如：Apache Spark、Docker和Kubernetes）看到软件技术的大量创新。

### 纷乱

服务设计与技术的进步，能使更多的人开始创建自己的服务，可以学习编程，使用框架，并且利用按需计算（serverless）进行服务的构建。可以利用微博、微信渠道与客户进行免费的沟通。随着我们市场的快速发展，任何一个创业公司的新点子的有效实施，都会使得原有公司的业务死的很惨。

而这个事实让大多数CIO和CTO感到害怕。随着软件成为成为公司构建服务，经验和差异化的关键因素，许多人意识到他们必须成为各自垂直行业的软件公司。以前企业将IT视为成本，而今发现它已经变为与对手比拼的关键，为了不落后于对手，他们必须变得敏捷起来。

### 拥抱组织结构的敏捷

大多数诞生于20世纪（工业时代）的公司并不是以敏捷的方式进行构建。它们的构建是为了最大限度地提高效率、减少流程中的变化、消除工人的创造性思维，并将工作人员组装成流水线的方式。整个过程被构建成类似机器一样，接受输入，经过高度定制调优的流程，完成生产输出。这种自上而下的分级管理结构，对于变化也是自上而下的思考，来自底层的信息经历了许多层面的管理和传达，最终到达高层，经过高层的决断后再下派到下层，而这一过程一般需要18个月左右的周期。这种组织方法能够极大的进行产品生产并尽可能的压榨流程中的每一点效率，但它并不适合用来提供服务。

<center>
<img src="https://github.com/weipeng2k/microservices-camp/raw/master/resource/chapter1-3.png" width="50%" height="50%" />
</center>

客户可不能放置在生产线上，他们想要什么时候出现就什么时候出现，他们喜欢和客户服务进行对话，而非一个自助电话系统。他们不会按定义好的菜单来填写，而是简单的对话输入，如果让他们等很久，他们会疯。

这意味着我们面向客户的服务需要考虑更多的变化，他们需要面对任何不可预知的输入。客户希望通过你提供的服务进行对话，如果该服务不足以满足他们的需求，那么就需要明确快速的反馈给他们有关如何解决的办法。该反馈可以由服务的维护者来把握，他可以快速调整服务和交互模型，以更好地适应客户，而不用等待自上而下的18个月规划周期。你需要你的前线业务团队能够快速的做出反应，需要自主、目标驱动和自组织的团队，他们负责为客户（付费客户、业务合作伙伴以及同行团队等）提供吸引人的用户体验。快速反馈周期、自主团队、共同目标和谈话是组织必须遵守的先决条件，只有这样企业才能够在未知的后工业时代生存下去。

说了这么多，没有一本微服务的书会这么介绍对于组织敏捷性的期望，但是会提到康威定律。

任何设计系统的组织，必然会产生以下设计结果：即其结构就是该组织沟通结构的写照。简单来说： 产品必然是其组织沟通结构的缩影。

> Any organization that designs a system (defined broadly) will produce a design whose structure is a copy of the organization's communication structure.

要建立敏捷软件系统，我们必须从构建敏捷的组织结构开始。敏捷的业务结构将有利于微服务技术的落地，但是构建分布式系统很困难，在接下来的部分中，我们将介绍在构建和设计这些服务时必须牢记的问题。

### 什么是微服务架构？

微服务架构（MSA）是一个使用服务的理念，将旧有的软件系统按照领域模型拆分成小规模、内聚的，且有上下文边界的设计方法论。这些服务相互隔离、自治，它们通过相互通信来完成业务功能。微服务是一个便于小团队开发的模式，它允许各个自治的小团队采用各自擅长的技术来实现服务，而不会给整个系统带来冲击。

<center>
<img src="https://github.com/weipeng2k/microservices-camp/raw/master/resource/chapter1-4.png" width="50%" height="50%" />
</center>

团队之间通过承诺来进行沟通，这种方式的目的是将服务发布的内容和计划让其他组件知晓，使他们能够使用到自己的服务，而描述这些承诺就是需要足够的wiki以及文档。如果文档不够好、API定义也不清晰，那么服务提供方就没有做好他们的工作。

每个团队都有涉及服务、技术选型、解决问题的职责，他们会在部署、管理服务上花时间，甚至可能会在凌晨2点起床处理问题。例如：在亚马逊，有一个单独的团队负责税率计算功能，而这个服务会在订购时被调用。这个服务的模型（Item，Address，Tax等）在团队内大家都心知肚明，这个团队拥有税率计算服务的设计、开发和运维的权限。围绕这些，亚马逊也提供了非常成熟的自动化技术，用于服务的构建、部署和运维。
